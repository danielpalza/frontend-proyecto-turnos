<div class="modal fade show d-block" *ngIf="open">
  <div class="modal-backdrop fade show" (click)="close()"></div>

  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nueva Cita</h5>
        <small class="text-muted ms-2">{{ formatDisplayDate(selectedDate) }}</small>
        <button type="button" class="btn-close" (click)="close()" [disabled]="isLoading"></button>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <app-patient-form
            [form]="form"
            [showSearch]="true"
            [showPaymentDetails]="true"
            [showAppointmentDetails]="true"
            [existingPatients]="existingPatients"
            [selectedPatient]="selectedPatient"
            [profesionales]="profesionales"
            [isCheckingAvailability]="isCheckingAvailability"
            [availabilityError]="availabilityError"
            [calcularResto]="calcularResto.bind(this)"
            (patientSelect)="selectPatient($event)"
            (clearPatient)="clearPatientSelection()"
          />
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="close()"
            [disabled]="isLoading"
          >
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary" 
            [disabled]="form.invalid || isLoading || isCheckingAvailability || availabilityError !== null">
            <span *ngIf="isLoading || isCheckingAvailability" class="spinner-border spinner-border-sm me-2"></span>
            {{ isLoading ? 'Guardando...' : (isCheckingAvailability ? 'Verificando...' : 'Guardar Cita') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
