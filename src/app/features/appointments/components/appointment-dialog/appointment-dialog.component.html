<!-- Modal Bootstrap -->
<div class="modal fade show d-block" *ngIf="open">
  <div class="modal-backdrop fade show" (click)="close()"></div>

  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title">Nueva Cita</h5>
        <small class="text-muted ms-2">{{ formatDisplayDate(selectedDate) }}</small>
        <button type="button" class="btn-close" (click)="close()"></button>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="modal-body">

          <!-- Datos Personales -->
          <section class="mb-4">
            <h6 class="mb-3 text-primary">
              <i class="bi bi-person me-2"></i>Datos Personales
            </h6>

            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Nombre y Apellido</label>
                <app-patient-combobox
                  [patients]="existingPatients"
                  [value]="form.get('nombreApellido')?.value || ''"
                  (valueChange)="form.get('nombreApellido')?.setValue($event)"
                  (selectPatient)="handlePatientSelect($event)"
                ></app-patient-combobox>
                <div *ngIf="form.get('nombreApellido')?.touched && form.get('nombreApellido')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Fecha de Nacimiento</label>
                <input class="form-control" type="date" formControlName="fechaNacimiento">
              </div>

              <div class="col-md-6">
                <label class="form-label">Edad</label>
                <input class="form-control bg-light" type="number" formControlName="edad" readonly>
              </div>

              <div class="col-md-6">
                <label class="form-label">DNI</label>
                <input class="form-control" type="text" formControlName="dni" />
                <div *ngIf="form.get('dni')?.touched && form.get('dni')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Teléfono</label>
                <input class="form-control" type="tel" formControlName="telefono" />
                <div *ngIf="form.get('telefono')?.touched && form.get('telefono')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input class="form-control" type="email" formControlName="email" />
                <div *ngIf="form.get('email')?.touched && form.get('email')?.invalid" class="text-danger small mt-1">
                  Email inválido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Domicilio</label>
                <input class="form-control" type="text" formControlName="domicilio" />
                <div *ngIf="form.get('domicilio')?.touched && form.get('domicilio')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Localidad</label>
                <input class="form-control" type="text" formControlName="localidad" />
                <div *ngIf="form.get('localidad')?.touched && form.get('localidad')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Contacto de Emergencia</label>
                <input class="form-control" type="text" formControlName="contactoEmergencia" />
                <div *ngIf="form.get('contactoEmergencia')?.touched && form.get('contactoEmergencia')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Anamnesis</label>
                <input class="form-control" type="text" formControlName="anamnesis" />
              </div>
            </div>
          </section>

          <!-- Cobertura -->
          <section class="mb-4">
            <h6 class="mb-3 text-primary">
              <i class="bi bi-shield-check me-2"></i>Cobertura
            </h6>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Obra Social - Nombre</label>
                <select class="form-select" formControlName="obraSocialNombre">
                  <option value="">Seleccione...</option>
                  <option *ngFor="let os of OBRAS_SOCIALES" [value]="os.value">{{ os.label }}</option>
                </select>
                <div *ngIf="form.get('obraSocialNombre')?.touched && form.get('obraSocialNombre')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Plan / Categoría</label>
                <input class="form-control" type="text" formControlName="planCategoria" />
                <div *ngIf="form.get('planCategoria')?.touched && form.get('planCategoria')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Número de Afiliado</label>
                <input class="form-control" type="text" formControlName="obraSocialNumero" />
                <div *ngIf="form.get('obraSocialNumero')?.touched && form.get('obraSocialNumero')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">¿Es titular?</label>
                <select class="form-select" formControlName="esTitular">
                  <option value="si">Sí</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="col-md-6" *ngIf="form.get('esTitular')?.value === 'no'">
                <label class="form-label">Nombre del Titular</label>
                <input class="form-control" type="text" formControlName="nombreTitular" />
                <div *ngIf="form.get('nombreTitular')?.touched && form.get('nombreTitular')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6" *ngIf="form.get('esTitular')?.value === 'no'">
                <label class="form-label">DNI del Titular</label>
                <input class="form-control" type="text" formControlName="dniTitular" />
                <div *ngIf="form.get('dniTitular')?.touched && form.get('dniTitular')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>

              <div class="col-md-6" *ngIf="form.get('esTitular')?.value === 'no'">
                <label class="form-label">Parentesco</label>
                <select class="form-select" formControlName="parentesco">
                  <option value="">Seleccione...</option>
                  <option value="padre">Padre</option>
                  <option value="madre">Madre</option>
                  <option value="tutor">Tutor</option>
                  <option value="conyuge">Cónyuge</option>
                  <option value="otro">Otro</option>
                </select>
                <div *ngIf="form.get('parentesco')?.touched && form.get('parentesco')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>
            </div>
          </section>

          <!-- Profesional -->
          <section class="mb-4">
            <h6 class="mb-3 text-primary">
              <i class="bi bi-person-badge me-2"></i>Profesional
            </h6>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Nombre del Profesional</label>
                <input class="form-control" list="profesionales-list" formControlName="profesional" placeholder="Dr. Ejemplo" />
                <datalist id="profesionales-list">
                  <option>Dr. Juan Pérez</option>
                  <option>Dra. María González</option>
                  <option>Dr. Carlos Rodríguez</option>
                </datalist>
                <div *ngIf="form.get('profesional')?.touched && form.get('profesional')?.invalid" class="text-danger small mt-1">
                  Este campo es requerido
                </div>
              </div>
            </div>
          </section>

          <!-- Detalles de Pago -->
          <section class="mb-4">
            <h6 class="mb-3 text-primary">
              <i class="bi bi-cash-coin me-2"></i>Detalles de Pago
            </h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Precio de Bono</label>
                <input class="form-control" type="number" step="0.01" formControlName="precioBono" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Precio de Tratamiento</label>
                <input class="form-control" type="number" step="0.01" formControlName="precioTratamiento" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Extras</label>
                <input class="form-control" type="number" step="0.01" formControlName="extras" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Monto de Pago del Cliente</label>
                <input class="form-control" type="number" step="0.01" formControlName="montoPago" />
              </div>

              <div class="col-12">
                <div class="p-3 bg-light rounded border">
                  <div class="d-flex justify-content-between">
                    <span>Resto a Pagar:</span>
                    <strong class="text-primary">$ {{ calcularResto() }}</strong>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Observaciones</label>
                <textarea class="form-control" rows="3" formControlName="observaciones"></textarea>
              </div>
            </div>
          </section>

        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" (click)="close()">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="form.invalid">
            <i class="bi bi-check-lg me-2"></i>Guardar Cita
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

