# Casos de Error y Mensajes para Suscripciones - TurnosViewComponent

## üìç Contexto
Este documento lista todos los casos de manejo de errores en suscripciones del componente `TurnosViewComponent`.

**Estado actual**: ‚úÖ **TODOS LOS CASOS IMPLEMENTADOS**

**Ubicaci√≥n del componente**: `turnos-view.component.ts`

---

## ‚úÖ Sistema de Manejo de Errores Implementado

El componente utiliza un sistema centralizado de manejo de errores que consta de:

1. **ErrorHandlerService**: Genera mensajes amigables seg√∫n el c√≥digo HTTP y contexto
2. **NotificationService**: Muestra notificaciones toast al usuario
3. **HttpContext (skipGlobal)**: Evita notificaciones duplicadas del interceptor global

### Flujo de manejo de errores:
```
Error HTTP ‚Üí ErrorHandlerService.getErrorMessage() ‚Üí NotificationService.showError()
```

---

## ‚úÖ Suscripciones con manejo de errores completo en `ngOnInit()`

### 1. Error al cargar turnos iniciales
**Estado**: ‚úÖ **IMPLEMENTADO**  
**Ubicaci√≥n**: `turnos-view.component.ts:57-72`

```typescript
this.appointmentsService.getAppointments().subscribe({
  next: (appointments) => {
    this.appointments = appointments;
    this.isLoadingAppointments = false;
    this.hasError = false;
  },
  error: (err) => {
    console.error('Error loading appointments:', err);
    const message = this.errorHandler.getErrorMessage(err, 'cargar los turnos');
    this.notification.showError(message);
    this.isLoadingAppointments = false;
    this.hasError = true;
    this.errorMessage = message;
  }
})
```

#### Cobertura de c√≥digos HTTP:

| C√≥digo HTTP | Tipo de Error | Mensaje Generado |
|------------|---------------|------------------|
| **0** | Sin conexi√≥n / Network Error | "No se pudo conectar con el servidor. Verifique su conexi√≥n a internet e intente nuevamente." |
| **400** | Bad Request | Mensaje del backend o gen√©rico seg√∫n ErrorHandlerService |
| **401** | Unauthorized | "Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente." |
| **403** | Forbidden | "No tiene permisos para cargar los turnos." |
| **404** | Not Found | Mensaje del backend o "No se encontr√≥ el servicio. Contacte al administrador." |
| **408** | Request Timeout | "La solicitud tard√≥ demasiado tiempo. Por favor, intente nuevamente." |
| **409** | Conflict | Mensaje del backend o gen√©rico seg√∫n contexto |
| **422** | Unprocessable Entity | Mensaje del backend o "Los datos no son v√°lidos. Verifique la informaci√≥n ingresada." |
| **500** | Internal Server Error | "Error interno del servidor. Por favor, intente m√°s tarde." |
| **502** | Bad Gateway | "El servidor no est√° disponible temporalmente. Intente nuevamente en unos momentos." |
| **503** | Service Unavailable | "El servicio no est√° disponible en este momento. Intente m√°s tarde." |
| **504** | Gateway Timeout | "El servidor tard√≥ demasiado en responder. Por favor, intente nuevamente." |
| **N/A** | Error desconocido | Mensaje del backend o "Ocurri√≥ un error inesperado al cargar los turnos. Por favor, intente nuevamente." |

**Caracter√≠sticas implementadas**:
- ‚úÖ Manejo de error con `ErrorHandlerService`
- ‚úÖ Notificaci√≥n toast al usuario
- ‚úÖ Actualizaci√≥n de estado (`hasError`, `errorMessage`, `isLoadingAppointments`)
- ‚úÖ Logging para debugging

---

### 2. Error al cargar pacientes iniciales
**Estado**: ‚úÖ **IMPLEMENTADO**  
**Ubicaci√≥n**: `turnos-view.component.ts:77-88`

```typescript
this.patientService.getPatients().subscribe({
  next: (patients) => {
    this.patients = patients;
    this.isLoadingPatients = false;
  },
  error: (err) => {
    const message = this.errorHandler.getErrorMessage(err, 'cargar los pacientes');
    this.notification.showError(message);
    this.isLoadingPatients = false;
    console.error('Error loading patients:', err);
  }
})
```

#### Cobertura de c√≥digos HTTP:

| C√≥digo HTTP | Tipo de Error | Mensaje Generado |
|------------|---------------|------------------|
| **0** | Sin conexi√≥n / Network Error | "No se pudo conectar con el servidor. Verifique su conexi√≥n a internet e intente nuevamente." |
| **400** | Bad Request | Mensaje del backend o gen√©rico seg√∫n ErrorHandlerService |
| **401** | Unauthorized | "Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente." |
| **403** | Forbidden | "No tiene permisos para cargar los pacientes." |
| **404** | Not Found | Mensaje del backend o "No se encontr√≥ el servicio. Contacte al administrador." |
| **408** | Request Timeout | "La solicitud tard√≥ demasiado tiempo. Por favor, intente nuevamente." |
| **409** | Conflict | Mensaje del backend o gen√©rico seg√∫n contexto |
| **422** | Unprocessable Entity | Mensaje del backend o "Los datos no son v√°lidos. Verifique la informaci√≥n ingresada." |
| **500** | Internal Server Error | "Error interno del servidor. Por favor, intente m√°s tarde." |
| **502** | Bad Gateway | "El servidor no est√° disponible temporalmente. Intente nuevamente en unos momentos." |
| **503** | Service Unavailable | "El servicio no est√° disponible en este momento. Intente m√°s tarde." |
| **504** | Gateway Timeout | "El servidor tard√≥ demasiado en responder. Por favor, intente nuevamente." |
| **N/A** | Error desconocido | Mensaje del backend o "Ocurri√≥ un error inesperado al cargar los pacientes. Por favor, intente nuevamente." |

**Caracter√≠sticas implementadas**:
- ‚úÖ Manejo de error con `ErrorHandlerService`
- ‚úÖ Notificaci√≥n toast al usuario
- ‚úÖ Actualizaci√≥n de estado (`isLoadingPatients`)
- ‚úÖ Logging para debugging

---

### 3. Error al cargar profesionales iniciales
**Estado**: ‚úÖ **IMPLEMENTADO**  
**Ubicaci√≥n**: `turnos-view.component.ts:93-104`

```typescript
this.profesionalService.getProfesionales().subscribe({
  next: (profesionales) => {
    this.profesionales = profesionales;
    this.isLoadingProfesionales = false;
  },
  error: (err) => {
    const message = this.errorHandler.getErrorMessage(err, 'cargar los profesionales');
    this.notification.showError(message);
    this.isLoadingProfesionales = false;
    console.error('Error loading profesionales:', err);
  }
})
```

#### Cobertura de c√≥digos HTTP:

| C√≥digo HTTP | Tipo de Error | Mensaje Generado |
|------------|---------------|------------------|
| **0** | Sin conexi√≥n / Network Error | "No se pudo conectar con el servidor. Verifique su conexi√≥n a internet e intente nuevamente." |
| **400** | Bad Request | Mensaje del backend o gen√©rico seg√∫n ErrorHandlerService |
| **401** | Unauthorized | "Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente." |
| **403** | Forbidden | "No tiene permisos para cargar los profesionales." |
| **404** | Not Found | Mensaje del backend o "No se encontr√≥ el servicio. Contacte al administrador." |
| **408** | Request Timeout | "La solicitud tard√≥ demasiado tiempo. Por favor, intente nuevamente." |
| **409** | Conflict | Mensaje del backend o gen√©rico seg√∫n contexto |
| **422** | Unprocessable Entity | Mensaje del backend o "Los datos no son v√°lidos. Verifique la informaci√≥n ingresada." |
| **500** | Internal Server Error | "Error interno del servidor. Por favor, intente m√°s tarde." |
| **502** | Bad Gateway | "El servidor no est√° disponible temporalmente. Intente nuevamente en unos momentos." |
| **503** | Service Unavailable | "El servicio no est√° disponible en este momento. Intente m√°s tarde." |
| **504** | Gateway Timeout | "El servidor tard√≥ demasiado en responder. Por favor, intente nuevamente." |
| **N/A** | Error desconocido | Mensaje del backend o "Ocurri√≥ un error inesperado al cargar los profesionales. Por favor, intente nuevamente." |

**Caracter√≠sticas implementadas**:
- ‚úÖ Manejo de error con `ErrorHandlerService`
- ‚úÖ Notificaci√≥n toast al usuario
- ‚úÖ Actualizaci√≥n de estado (`isLoadingProfesionales`)
- ‚úÖ Logging para debugging

---

## ‚úÖ Suscripciones con manejo de error completo en operaciones CRUD

### 4. Error al crear paciente nuevo
**Estado**: ‚úÖ **IMPLEMENTADO**  
**Ubicaci√≥n**: `turnos-view.component.ts:150-173`

```typescript
// Pasar true para indicar que el componente manejar√° el error espec√≠ficamente
this.patientService.create(data.patientData as Patient, true).subscribe({
  next: (newPatient) => {
    // Validar que el paciente se cre√≥ correctamente
    if (!newPatient.id) {
      this.isLoading = false;
      this.notification.showError('Error al crear el paciente. El ID no fue generado correctamente.');
      return;
    }
    // Continuar con la creaci√≥n del turno...
  },
  error: (err) => {
    const message = this.errorHandler.getErrorMessage(err, 'crear el paciente');
    this.notification.showError(message);
    this.isLoading = false;
    console.error('Error creating patient:', err);
  }
});
```

#### Cobertura de c√≥digos HTTP:

| C√≥digo HTTP | Tipo de Error | Mensaje Generado |
|------------|---------------|------------------|
| **0** | Sin conexi√≥n / Network Error | "No se pudo crear el paciente. Verifique su conexi√≥n e intente nuevamente." |
| **400** | Bad Request (Validaci√≥n) | Mensaje del backend o gen√©rico seg√∫n ErrorHandlerService |
| **401** | Unauthorized | "Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente." |
| **403** | Forbidden | "No tiene permisos para crear el paciente." |
| **404** | Not Found | Mensaje del backend o "No se encontr√≥ el servicio. Contacte al administrador." |
| **409** | Conflict (DNI duplicado) | **"Ya existe un paciente con este DNI. Por favor, verifique el n√∫mero de documento."** (mensaje espec√≠fico) |
| **422** | Unprocessable Entity | Mensaje del backend o "Los datos no son v√°lidos. Verifique la informaci√≥n ingresada." |
| **500** | Internal Server Error | "Error interno del servidor. Por favor, intente m√°s tarde." |
| **502** | Bad Gateway | "El servidor no est√° disponible temporalmente. Intente nuevamente en unos momentos." |
| **503** | Service Unavailable | "El servicio no est√° disponible en este momento. Intente m√°s tarde." |
| **N/A** | Error desconocido | Mensaje del backend o "Ocurri√≥ un error inesperado al crear el paciente. Por favor, intente nuevamente." |

**Caracter√≠sticas implementadas**:
- ‚úÖ Manejo de error con `ErrorHandlerService`
- ‚úÖ Notificaci√≥n toast al usuario
- ‚úÖ Actualizaci√≥n de estado (`isLoading`)
- ‚úÖ Uso de `skipGlobal: true` para evitar notificaciones duplicadas del interceptor
- ‚úÖ Validaci√≥n adicional del ID del paciente creado
- ‚úÖ Logging para debugging

---

### 5. Error al crear turno
**Estado**: ‚úÖ **IMPLEMENTADO**  
**Ubicaci√≥n**: `turnos-view.component.ts:194-207`

```typescript
// Pasar true para indicar que el componente manejar√° el error espec√≠ficamente
this.appointmentsService.create(data, true).subscribe({
  next: () => {
    this.isDialogOpen = false;
    this.isLoading = false;
    this.notification.showSuccess('Turno creado correctamente.');
  },
  error: (err) => {
    const message = this.errorHandler.getErrorMessage(err, 'crear el turno');
    this.notification.showError(message);
    this.isLoading = false;
    console.error('Error creating appointment:', err);
    // No cerrar el di√°logo en caso de error para que el usuario pueda corregir
  }
});
```

#### Cobertura de c√≥digos HTTP:

| C√≥digo HTTP | Tipo de Error | Mensaje Generado |
|------------|---------------|------------------|
| **0** | Sin conexi√≥n / Network Error | "No se pudo crear el turno. Verifique su conexi√≥n e intente nuevamente." |
| **400** | Bad Request (Validaci√≥n) | Mensaje del backend o gen√©rico seg√∫n ErrorHandlerService |
| **401** | Unauthorized | "Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente." |
| **403** | Forbidden | "No tiene permisos para crear el turno." |
| **404** | Not Found | Mensaje del backend o "No se encontr√≥ el servicio. Contacte al administrador." |
| **409** | Conflict (Horario ocupado) | **"El horario seleccionado ya est√° ocupado. Por favor, elija otro horario."** (mensaje espec√≠fico) |
| **422** | Unprocessable Entity | Mensaje del backend o "Los datos no son v√°lidos. Verifique la informaci√≥n ingresada." |
| **500** | Internal Server Error | "Error interno del servidor. Por favor, intente m√°s tarde." |
| **502** | Bad Gateway | "El servidor no est√° disponible temporalmente. Intente nuevamente en unos momentos." |
| **503** | Service Unavailable | "El servicio no est√° disponible en este momento. Intente m√°s tarde." |
| **N/A** | Error desconocido | Mensaje del backend o "Ocurri√≥ un error inesperado al crear el turno. Por favor, intente nuevamente." |

**Caracter√≠sticas implementadas**:
- ‚úÖ Manejo de error con `ErrorHandlerService`
- ‚úÖ Notificaci√≥n toast al usuario
- ‚úÖ Actualizaci√≥n de estado (`isLoading`)
- ‚úÖ Uso de `skipGlobal: true` para evitar notificaciones duplicadas del interceptor
- ‚úÖ **Mejora UX**: No cierra el di√°logo en caso de error (permite al usuario corregir)
- ‚úÖ Logging para debugging

---

### 6. Error al eliminar turno
**Estado**: ‚úÖ **IMPLEMENTADO**  
**Ubicaci√≥n**: `turnos-view.component.ts:217-226`

```typescript
// Pasar true para indicar que el componente manejar√° el error espec√≠ficamente
this.appointmentsService.delete(id, true).subscribe({
  next: () => {
    this.notification.showSuccess('Turno eliminado correctamente.');
  },
  error: (err) => {
    const message = this.errorHandler.getErrorMessage(err, 'eliminar el turno');
    this.notification.showError(message);
    console.error('Error deleting appointment:', err);
  }
});
```

#### Cobertura de c√≥digos HTTP:

| C√≥digo HTTP | Tipo de Error | Mensaje Generado |
|------------|---------------|------------------|
| **0** | Sin conexi√≥n / Network Error | "No se pudo eliminar el turno. Verifique su conexi√≥n e intente nuevamente." |
| **400** | Bad Request | Mensaje del backend o gen√©rico seg√∫n ErrorHandlerService |
| **401** | Unauthorized | "Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente." |
| **403** | Forbidden | "No tiene permisos para eliminar el turno." |
| **404** | Not Found | **"El turno que intenta eliminar no existe o ya fue eliminado."** (mensaje espec√≠fico) |
| **409** | Conflict | Mensaje del backend o gen√©rico seg√∫n contexto |
| **500** | Internal Server Error | "Error interno del servidor. Por favor, intente m√°s tarde." |
| **502** | Bad Gateway | "El servidor no est√° disponible temporalmente. Intente nuevamente en unos momentos." |
| **503** | Service Unavailable | "El servicio no est√° disponible en este momento. Intente m√°s tarde." |
| **N/A** | Error desconocido | Mensaje del backend o "Ocurri√≥ un error inesperado al eliminar el turno. Por favor, intente nuevamente." |

**Caracter√≠sticas implementadas**:
- ‚úÖ Manejo de error con `ErrorHandlerService`
- ‚úÖ Notificaci√≥n toast al usuario
- ‚úÖ Uso de `skipGlobal: true` para evitar notificaciones duplicadas del interceptor
- ‚úÖ Logging para debugging

---

## üìù Notas de Implementaci√≥n

### Sistema de Manejo de Errores

El componente utiliza un sistema centralizado de manejo de errores:

1. **ErrorHandlerService** (`error-handler.service.ts`):
   - Genera mensajes amigables seg√∫n c√≥digo HTTP y contexto
   - Extrae mensajes del backend cuando est√°n disponibles
   - Proporciona mensajes gen√©ricos cuando no hay mensaje del backend
   - Maneja casos especiales (conflictos, red, etc.)

2. **NotificationService** (`notification.service.ts`):
   - Muestra notificaciones toast al usuario
   - Soporta diferentes tipos: success, error, warning, info
   - Auto-cierre configurable

3. **HttpContext (skipGlobal)**:
   - Evita notificaciones duplicadas del interceptor global
   - Permite manejo espec√≠fico en componentes cuando es necesario
   - Se usa en operaciones CRUD cr√≠ticas (create, delete)

### Prioridad de Mensajes

1. **Mensaje del backend** (si est√° disponible) - Prioridad m√°s alta
2. **Mensaje espec√≠fico seg√∫n contexto** (conflictos, red, etc.)
3. **Mensaje gen√©rico seg√∫n c√≥digo HTTP** - Prioridad m√°s baja

### Cobertura de C√≥digos HTTP

El sistema maneja todos los c√≥digos HTTP relevantes:
- ‚úÖ **0**: Errores de red/conexi√≥n
- ‚úÖ **400**: Bad Request (validaci√≥n)
- ‚úÖ **401**: Unauthorized (sesi√≥n expirada)
- ‚úÖ **403**: Forbidden (sin permisos)
- ‚úÖ **404**: Not Found (recurso no encontrado)
- ‚úÖ **408**: Request Timeout
- ‚úÖ **409**: Conflict (con mensajes espec√≠ficos seg√∫n contexto)
- ‚úÖ **422**: Unprocessable Entity (validaci√≥n)
- ‚úÖ **500**: Internal Server Error
- ‚úÖ **502**: Bad Gateway
- ‚úÖ **503**: Service Unavailable
- ‚úÖ **504**: Gateway Timeout
- ‚úÖ **Default**: Errores desconocidos

### Mejoras de UX Implementadas

1. **No cerrar di√°logo en error**: Al crear turno, si hay error, el di√°logo permanece abierto para que el usuario pueda corregir
2. **Actualizaci√≥n de estados**: Se actualizan flags de loading y error para feedback visual
3. **Mensajes contextuales**: Los mensajes son espec√≠ficos seg√∫n la acci√≥n realizada
4. **Prevenci√≥n de duplicados**: Uso de `skipGlobal` evita notificaciones duplicadas

### Consideraciones Adicionales

1. **Errores de red (status 0)**: 
   - Detectados autom√°ticamente
   - Mensajes espec√≠ficos seg√∫n contexto (crear paciente, crear turno, eliminar)

2. **Errores de validaci√≥n (400, 422)**: 
   - Extraen detalles del error del backend si est√°n disponibles
   - Mensajes gen√©ricos si no hay detalles

3. **Errores de autenticaci√≥n (401)**: 
   - Mensaje claro sobre sesi√≥n expirada
   - (Futuro: redirecci√≥n a login)

4. **Errores de permisos (403)**: 
   - Mensaje claro sobre falta de permisos
   - Contexto espec√≠fico seg√∫n la acci√≥n

5. **Errores de conflicto (409)**: 
   - Mensajes espec√≠ficos:
     - DNI duplicado al crear paciente
     - Horario ocupado al crear turno
   - Mensaje gen√©rico para otros conflictos

6. **Errores del servidor (500, 502, 503, 504)**: 
   - Mensajes que sugieren intentar m√°s tarde
   - No exponen detalles t√©cnicos al usuario

---

## ‚úÖ Resumen de Estado

| Caso | Estado | Ubicaci√≥n | Caracter√≠sticas |
|------|--------|-----------|-----------------|
| 1. Cargar turnos | ‚úÖ Implementado | `turnos-view.component.ts:57-72` | ErrorHandler + Notification + Estado |
| 2. Cargar pacientes | ‚úÖ Implementado | `turnos-view.component.ts:77-88` | ErrorHandler + Notification + Estado |
| 3. Cargar profesionales | ‚úÖ Implementado | `turnos-view.component.ts:93-104` | ErrorHandler + Notification + Estado |
| 4. Crear paciente | ‚úÖ Implementado | `turnos-view.component.ts:150-173` | ErrorHandler + Notification + skipGlobal |
| 5. Crear turno | ‚úÖ Implementado | `turnos-view.component.ts:194-207` | ErrorHandler + Notification + skipGlobal + UX |
| 6. Eliminar turno | ‚úÖ Implementado | `turnos-view.component.ts:217-226` | ErrorHandler + Notification + skipGlobal |

**Conclusi√≥n**: Todos los casos de error documentados est√°n completamente implementados con un sistema robusto y centralizado de manejo de errores.
